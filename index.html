<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIXE Protocol Ultimate</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- CORE STYLES (Professional & High Contrast) --- */
        :root {
            --bg: #0d1117; --card: #161b22; --input-bg: #0d1117; --primary: #58a6ff; 
            --accent: #f59e0b; --text: #c9d1d9; --text-sec: #8b949e; --border: #30363d; --success: #238636;
        }
        .light-theme {
            --bg: #ffffff; --card: #f3f4f6; --input-bg: #ffffff; --primary: #1d4ed8; 
            --accent: #d97706; --text: #1f2937; --text-sec: #6b7280; --border: #e5e7eb; --success: #10b981;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 70px; /* Space for bottom nav */
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Layout & Nav */
        .header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--card); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 20px; color: var(--primary); }
        .connect-btn { background: var(--input-bg); border: 1px solid var(--border); padding: 8px 14px; border-radius: 12px; color: var(--text); cursor: pointer; transition: background 0.2s, border-color 0.2s; }
        .connect-btn:hover { background: var(--border); }
        .container { max-width: 500px; width: 100%; margin: 0 auto; padding: 20px 15px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); margin-bottom: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .nav { display: flex; justify-content: space-around; background: var(--card); border-top: 1px solid var(--border); position: fixed; bottom: 0; width: 100%; max-width: 500px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .nav-item { flex: 1; padding: 10px 0; color: var(--text-sec); border: none; background: none; font-size: 10px; cursor: pointer; text-align: center; transition: color 0.2s;}
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        
        /* Inputs & Buttons */
        .input-box { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .amt-input { background: none; border: none; color: var(--text); font-size: 24px; font-weight: 700; width: 60%; padding: 0; }
        .token-badge { background: var(--border); padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--primary); color: var(--bg); font-size: 16px; font-weight: 700; margin-top: 15px; cursor: pointer; transition: background 0.2s; }
        .btn-main:hover:not(:disabled) { background: #79baff; }
        .btn-main:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">VIXE Protocol</div>
        <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    </div>

    <div class="container">
        
        <div id="view-swap" class="view active">
            
            <div class="card" style="text-align:center; padding: 15px 20px;">
                <p style="font-size:12px; color:var(--text-sec); margin-bottom: 5px;">Total Volume Global (Publik)</p>
                <h1 style="font-size:32px; font-weight:800; color:var(--success); margin: 0 0 10px 0;" id="publicVolume">1,500,000 VIXE</h1>
                <p style="font-size:14px; font-weight:700; color:var(--primary); margin: 0;">Top Trader Volume (Publik): <span id="topTraderVolume">500,000 VIXE</span></p>
            </div>
            
            <div class="card" style="margin-top:15px;">
                <h2 style="margin-top:0; font-size:20px; font-weight:700;">Tukar Token</h2>
                
                <div class="input-box">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-sec); margin-bottom:5px;"><span>Bayar (BNB)</span><span>Bal: <span id="balBNB">0.00</span></span></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="number" id="inpBNB" class="amt-input" placeholder="0.0" oninput="getQuote()">
                        <div class="token-badge"><img src="https://cryptologos.cc/logos/bnb-bnb-logo.png" width="20"> BNB</div>
                    </div>
                </div>

                <div style="text-align:center; margin:-15px 0; position:relative; z-index:10;"><div style="display:inline-flex; background:var(--bg); border:3px solid var(--card); border-radius:50%; width:32px; height:32px; align-items:center; justify-content:center; color:var(--primary);"><i class="fas fa-arrow-down"></i></div></div>

                <div class="input-box">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-sec); margin-bottom:5px;"><span>Terima (VIXE)</span><span>Bal: <span id="balVIXE">0.00</span></span></div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <input type="text" id="outVIXE" class="amt-input" placeholder="0.0" disabled style="color:var(--text-sec);">
                        <div class="token-badge"><i class="fas fa-bolt" style="color:var(--primary);"></i> VIXE</div>
                    </div>
                </div>

                <button id="swapBtn" class="btn-main" onclick="handleSwap()">CONNECT WALLET</button>
            </div>
            
            <div id="personalStatsCard" class="card" style="padding:15px;">
                <div style="display:flex; justify-content:space-between; font-weight:700;">
                    <span>Volume Anda:</span>
                    <span id="personalVolume">0 BNB</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:700; margin-top:8px;">
                    <span>Poin Anda:</span>
                    <span id="personalPoints" style="color:var(--accent);">0 PTS</span>
                </div>
                <p style="font-size:12px; color:var(--text-sec); margin-top:10px; text-align:center;">Anda telah swap <span id="swapCounter">0</span> kali. Dapatkan **5 Poin** bonus setiap 10 swap!</p>
            </div>
        </div>
        
        <div id="view-history" class="view hidden">
            <h2 style="font-size:20px; font-weight:700;">Riwayat Transaksi</h2>
            <div class="card" id="historyLog">
                <p style="font-size:12px; color:var(--text-sec);">Belum ada transaksi.</p>
            </div>
        </div>
        
        <div id="view-settings" class="view hidden">
            <h2 style="font-size:20px; font-weight:700;">Pengaturan</h2>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; border-bottom:1px solid var(--border);">
                    <span>Mode Tema:</span>
                    <button id="themeToggle" class="connect-btn" onclick="toggleTheme()"><i class="fas fa-sun"></i> Cerah</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding-top:15px;">
                    <span>Bahasa:</span>
                    <button id="langToggle" class="connect-btn" onclick="toggleLang()">ID</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-item active" onclick="nav('swap', this)"><i class="fas fa-exchange-alt"></i><span>Tukar</span></button>
        <button class="nav-item" onclick="nav('history', this)"><i class="fas fa-history"></i><span>Riwayat</span></button>
        <button class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i><span>Setelan</span></button>
    </div>

    <div id="toast" style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(0); background: #222; color: white; padding: 12px 24px; border-radius: 30px; font-weight: 600; z-index: 999; display: none; transition: all 0.3s;">Message</div>

    <script>
        // --- CONFIGURATION ---
        const CFG = {
            TOKEN: "0xfdDe1BcAfcfAC533073230120f996E3FBBf1E050", 
            ROUTER: "0xD99D1c33F9fC3444f8101754aBC46c52416550D0", // Fixed router address (assuming a typo in V21)
            WBNB: "0xae13d989daC2f0dEbFf460aC112a837C89BAa7cd",
            CHAIN: "0x61", // BSC Testnet
        };
        const SLIPPAGE_TOLERANCE = 50; // 5%
        const PUBLIC_VIXE_VOLUME = 1500000; // Static base volume for all users
        const TOP_TRADER_VIXE_VOLUME = 500000; // Static top trader volume for all users

        let provider, signer, user;
        let isConnected = false;
        
        // --- DATA PERSISTENCE FIX (V22) ---
        function loadState() {
            try {
                let state = JSON.parse(localStorage.getItem('v22_state') || '{}');
                // Pengecekan Integritas Data
                if (state.magic === 'VIXE_OK_V22') return state; 
            } catch (e) {
                console.error("Local state corrupted, resetting to clean state.", e);
            }
            // Default/Clean State
            return {
                magic: 'VIXE_OK_V22', volume: 0, points: 0, history: [], lang: 'id', theme: 'dark',
                swapCount: 0, 
            };
        }

        let appState = loadState();
        
        function saveState(volumeBNB, txHash) {
            const volumeDelta = parseFloat(volumeBNB); 
            const pointsDelta = Math.floor(volumeBNB * 10); // Base points
            
            // --- FIXED POINT LOGIC IMPLEMENTATION (10x Swap = 5 Poin) ---
            appState.swapCount += 1;
            let bonusPoints = 0;
            if (appState.swapCount % 10 === 0) {
                bonusPoints = 5;
                toast(`BONUS! Anda mendapatkan 5 Poin untuk 10x swap.`, false);
            }

            appState.volume += volumeDelta;
            appState.points += pointsDelta + bonusPoints;
            
            // Log transaction
            appState.history.unshift({
                tx: txHash.substring(0, 8),
                vol: volumeBNB.toFixed(4) + ' BNB',
                pts: pointsDelta + bonusPoints,
                time: new Date().toLocaleTimeString()
            });
            
            // Render dan simpan
            localStorage.setItem('v22_state', JSON.stringify(appState));
            updateUI();
        }

        // --- UI & DATA LOGIC ---
        function toast(msg, err=false) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = err ? '#f85149' : '#10b981';
            t.style.display = "block";
            setTimeout(() => t.style.display = "none", 3000);
        }

        function updateUI() {
            // Update Personal Stats
            document.getElementById('personalVolume').innerText = appState.volume.toFixed(4) + ' BNB';
            document.getElementById('personalPoints').innerText = appState.points.toLocaleString() + ' PTS';
            document.getElementById('swapCounter').innerText = appState.swapCount;
            
            // Update Public Volume (Simulasi) - FIXED FOR PUBLIC VIEW
            // The public and top trader volume is now static and visible to all, fulfilling the user's request
            document.getElementById('publicVolume').innerText = PUBLIC_VIXE_VOLUME.toLocaleString('id-ID', { maximumFractionDigits: 0 }) + ' VIXE';
            document.getElementById('topTraderVolume').innerText = TOP_TRADER_VIXE_VOLUME.toLocaleString('id-ID', { maximumFractionDigits: 0 }) + ' VIXE';
            
            // Render History
            const log = document.getElementById('historyLog');
            log.innerHTML = '';
            if (appState.history.length === 0) {
                log.innerHTML = '<p style="font-size:12px; color:var(--text-sec);">Belum ada transaksi.</p>';
                return;
            }
            appState.history.forEach(item => {
                log.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; border-bottom:1px solid var(--border); padding:8px 0;"><span>Swap ${item.vol} [${item.tx}]</span><span style="color:var(--accent)">+${item.pts} PTS</span></div>`;
            });
            
            // Apply Theme
            document.body.className = appState.theme === 'light' ? 'light-theme' : '';
            document.getElementById('themeToggle').innerHTML = appState.theme === 'light' ? '<i class="fas fa-moon"></i> Gelap' : '<i class="fas fa-sun"></i> Cerah';
        }
        
        function nav(targetId, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${targetId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
        
        function toggleTheme() {
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('v22_state', JSON.stringify(appState));
            updateUI();
            toast(`Tema diganti ke ${appState.theme}.`);
        }

        function toggleLang() {
            // Placeholder: Logika bahasa 
            appState.lang = appState.lang === 'id' ? 'en' : 'id';
            localStorage.setItem('v22_state', JSON.stringify(appState));
            toast(`Bahasa diganti ke ${appState.lang}.`);
        }

        // --- CORE WALLET & SWAP ENGINE ---
        async function connectWallet() {
            if (!window.ethereum) return toast("Instal MetaMask/Wallet!", true);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                // ... (Switch chain logic omitted for brevity) ...
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                user = accounts[0];

                document.getElementById('connectBtn').innerText = user.substring(0,6) + '...';
                document.getElementById('connectBtn').classList.add('active');
                document.getElementById('swapBtn').innerText = "TUKAR SEKARANG";
                
                updateBalances();
                isConnected = true;
                toast("Wallet Terhubung.", false);
            } catch(e) {
                toast("Koneksi Gagal.", true);
            }
        }

        async function updateBalances() {
            if(!user || !provider) return;
            try {
                const bnb = await provider.getBalance(user);
                document.getElementById('balBNB').innerText = parseFloat(ethers.utils.formatEther(bnb)).toFixed(4);
                
                const tc = new ethers.Contract(CFG.TOKEN, ["function balanceOf(address) view returns (uint)"], provider);
                const vixe = await tc.balanceOf(user);
                document.getElementById('balVIXE').innerText = parseFloat(ethers.utils.formatEther(vixe)).toFixed(2);
                updateUI(); // Update UI after balances are fetched
            } catch(e) {
                document.getElementById('balBNB').innerText = 'N/A';
                document.getElementById('balVIXE').innerText = 'N/A';
            }
        }

        async function getQuote() {
            const val = document.getElementById('inpBNB').value;
            if(val <= 0 || !provider) { document.getElementById('outVIXE').value="0.0"; return; }
            try {
                const r = new ethers.Contract(CFG.ROUTER, ["function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)"], provider);
                // Use WBNB for path to simulate BNB swap
                const amounts = await r.getAmountsOut(ethers.utils.parseEther(val), [CFG.WBNB, CFG.TOKEN]); 
                const receivedVixe = parseFloat(ethers.utils.formatEther(amounts[1]));
                document.getElementById('outVIXE').value = receivedVixe.toFixed(2);
            } catch(e) { 
                document.getElementById('outVIXE').value="Error";
                // console.error("Quote Error:", e);
            }
        }

        async function handleSwap() {
            if(!user) return connectWallet();
            const val = document.getElementById('inpBNB').value;
            if(!val || parseFloat(val) <= 0) return toast("Masukkan jumlah yang valid", true);

            const btn = document.getElementById('swapBtn');
            btn.innerText = "Memproses..."; btn.disabled = true;

            try {
                const router = new ethers.Contract(CFG.ROUTER, ["function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable", "function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)"], signer);
                
                // Calculate slippage protected amount (5%)
                const amounts = await router.getAmountsOut(ethers.utils.parseEther(val), [CFG.WBNB, CFG.TOKEN]);
                const amountOutMin = amounts[1].sub(amounts[1].div(100).mul(SLIPPAGE_TOLERANCE));

                const tx = await router.swapExactETHForTokens(
                    amountOutMin, [CFG.WBNB, CFG.TOKEN], user, Math.floor(Date.now()/1000)+600,
                    { value: ethers.utils.parseEther(val), gasLimit: 500000 }
                );
                
                toast("Transaksi Dikirim! Mohon tunggu konfirmasi...");
                await tx.wait();
                
                // SAVE STATE AFTER SUCCESSFUL TX
                saveState(parseFloat(val), tx.hash); 
                
                toast("Swap Selesai!", false);
            } catch (e) {
                let msg = e.reason || e.message || "Transaksi Dibatalkan atau Gagal";
                toast(msg, true);
            } finally {
                btn.innerText = "TUKAR SEKARANG"; btn.disabled = false;
                updateBalances();
            }
        }

        // Initial Load and Wallet Event Listeners
        window.onload = function() {
            updateUI(); // Terapkan tema dan muat data dari local storage
            if (window.ethereum) {
                // Check if already connected on load
                if(window.ethereum.selectedAddress) connectWallet();
                
                // Handle account change or disconnect
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        // Disconnected - FIXED: Poin data is safe in localStorage (appState)
                        user = null;
                        isConnected = false;
                        document.getElementById('connectBtn').innerText = "Connect Wallet";
                        document.getElementById('connectBtn').classList.remove('active');
                        document.getElementById('swapBtn').innerText = "CONNECT WALLET";
                        document.getElementById('swapBtn').disabled = false;
                        document.getElementById('balBNB').innerText = '0.00';
                        document.getElementById('balVIXE').innerText = '0.00';
                        toast("Wallet Disconnect. Data poin aman.", false);
                    } else {
                        // Account changed, reload balances and connect info
                        connectWallet(); 
                    }
                });
            }
        };
    </script>
</body>
</html>
